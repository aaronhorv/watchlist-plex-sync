<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMDB to Plex Watchlist Sync</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ImdbPlexSync = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [config, setConfig] = useState({
                imdbListUrl: '',
                plexToken: '',
                tmdbApiKey: '',
                region: 'US',
                streamingServices: []
            });
            const [syncStatus, setSyncStatus] = useState({
                lastSync: null,
                status: 'idle',
                processed: 0,
                added: 0,
                skipped: 0
            });
            const [logs, setLogs] = useState([]);
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);

            const streamingProviders = [
                { id: 8, name: 'Netflix' },
                { id: 350, name: 'Apple TV+' },
                { id: 384, name: 'HBO Max' },
                { id: 9, name: 'Amazon Prime Video' },
                { id: 337, name: 'Disney+' },
                { id: 531, name: 'Paramount+' },
                { id: 389, name: 'Peacock' },
                { id: 1899, name: 'Max' }
            ];

            const regions = [
                'US', 'GB', 'DE', 'FR', 'ES', 'IT', 'NL', 'BE', 'CA', 'AU', 'JP', 'BR'
            ];

            useEffect(() => {
                loadConfig();
                loadLogs();
                loadStatus();
                loadResults();
            }, []);

            const loadConfig = async () => {
                try {
                    const response = await fetch('/api/config');
                    const data = await response.json();
                    setConfig(data);
                } catch (error) {
                    console.error('Error loading config:', error);
                }
            };

            const loadLogs = async () => {
                try {
                    const response = await fetch('/api/logs');
                    const data = await response.json();
                    setLogs(data);
                } catch (error) {
                    console.error('Error loading logs:', error);
                }
            };

            const loadStatus = async () => {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    setSyncStatus(data);
                } catch (error) {
                    console.error('Error loading status:', error);
                }
            };

            const loadResults = async () => {
                try {
                    const response = await fetch('/api/results');
                    const data = await response.json();
                    setResults(data);
                } catch (error) {
                    console.error('Error loading results:', error);
                }
            };

            const handleServiceToggle = (serviceId) => {
                setConfig(prev => ({
                    ...prev,
                    streamingServices: prev.streamingServices.includes(serviceId)
                        ? prev.streamingServices.filter(id => id !== serviceId)
                        : [...prev.streamingServices, serviceId]
                }));
            };

            const handleSyncNow = async () => {
                setLoading(true);
                setSyncStatus(prev => ({ ...prev, status: 'running' }));
                
                try {
                    await fetch('/api/sync', { method: 'POST' });
                    
                    setTimeout(() => {
                        loadLogs();
                        loadStatus();
                        loadResults();
                        setLoading(false);
                    }, 2000);
                } catch (error) {
                    console.error('Error triggering sync:', error);
                    setLoading(false);
                }
            };

            const saveConfig = async () => {
                try {
                    await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    alert('Configuration saved!');
                    loadLogs();
                } catch (error) {
                    console.error('Error saving config:', error);
                    alert('Error saving configuration');
                }
            };

            const getStatusBadge = (status) => {
                const badges = {
                    'added': 'bg-green-500/20 text-green-400 border-green-500',
                    'skipped': 'bg-yellow-500/20 text-yellow-400 border-yellow-500',
                    'failed': 'bg-red-500/20 text-red-400 border-red-500',
                    'processing': 'bg-blue-500/20 text-blue-400 border-blue-500'
                };
                return badges[status] || 'bg-gray-500/20 text-gray-400 border-gray-500';
            };

            return (
                <div className="min-h-screen bg-gray-900 text-gray-100">
                    <div className="container mx-auto p-6 max-w-7xl">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold mb-2">IMDB to Plex Watchlist Sync</h1>
                            <p className="text-gray-400">Automatically sync IMDB watchlist to Plex, filtering by streaming availability</p>
                        </div>

                        <div className="flex gap-2 mb-6 border-b border-gray-700">
                            <button
                                onClick={() => setActiveTab('dashboard')}
                                className={`px-4 py-2 font-medium transition-colors ${
                                    activeTab === 'dashboard'
                                        ? 'text-blue-400 border-b-2 border-blue-400'
                                        : 'text-gray-400 hover:text-gray-200'
                                }`}
                            >
                                Dashboard
                            </button>
                            <button
                                onClick={() => setActiveTab('results')}
                                className={`px-4 py-2 font-medium transition-colors ${
                                    activeTab === 'results'
                                        ? 'text-blue-400 border-b-2 border-blue-400'
                                        : 'text-gray-400 hover:text-gray-200'
                                }`}
                            >
                                Results
                            </button>
                            <button
                                onClick={() => setActiveTab('config')}
                                className={`px-4 py-2 font-medium transition-colors ${
                                    activeTab === 'config'
                                        ? 'text-blue-400 border-b-2 border-blue-400'
                                        : 'text-gray-400 hover:text-gray-200'
                                }`}
                            >
                                Configuration
                            </button>
                            <button
                                onClick={() => setActiveTab('logs')}
                                className={`px-4 py-2 font-medium transition-colors ${
                                    activeTab === 'logs'
                                        ? 'text-blue-400 border-b-2 border-blue-400'
                                        : 'text-gray-400 hover:text-gray-200'
                                }`}
                            >
                                Logs
                            </button>
                        </div>

                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-gray-800 p-6 rounded-lg">
                                        <div className="text-gray-400 text-sm mb-1">Last Sync</div>
                                        <div className="text-2xl font-bold">
                                            {syncStatus.lastSync 
                                                ? new Date(syncStatus.lastSync).toLocaleString()
                                                : 'Never'}
                                        </div>
                                    </div>
                                    <div className="bg-gray-800 p-6 rounded-lg">
                                        <div className="text-gray-400 text-sm mb-1">Items Processed</div>
                                        <div className="text-2xl font-bold">{syncStatus.processed}</div>
                                    </div>
                                    <div className="bg-gray-800 p-6 rounded-lg">
                                        <div className="text-gray-400 text-sm mb-1">Added to Plex</div>
                                        <div className="text-2xl font-bold text-green-400">{syncStatus.added}</div>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Sync Status</h2>
                                        <button
                                            onClick={handleSyncNow}
                                            disabled={loading}
                                            className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 px-4 py-2 rounded-lg font-medium transition-colors"
                                        >
                                            {loading ? 'Syncing...' : 'Sync Now'}
                                        </button>
                                    </div>
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full ${
                                                syncStatus.status === 'running' ? 'bg-yellow-400 animate-pulse' :
                                                syncStatus.status === 'completed' ? 'bg-green-400' : 'bg-gray-600'
                                            }`} />
                                            <span className="capitalize">{syncStatus.status}</span>
                                        </div>
                                        {syncStatus.skipped > 0 && (
                                            <div className="text-sm text-gray-400">
                                                {syncStatus.skipped} items skipped (available on streaming services)
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'results' && (
                            <div className="bg-gray-800 rounded-lg overflow-hidden">
                                <div className="p-6 border-b border-gray-700">
                                    <h2 className="text-xl font-semibold">Sync Results</h2>
                                </div>
                                {results.length === 0 ? (
                                    <div className="p-8 text-center text-gray-400">
                                        No sync results yet. Click "Sync Now" to start.
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-700">
                                                <tr>
                                                    <th className="px-4 py-3 text-left text-sm font-medium">Title</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium">Year</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium">Status</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium">Streaming</th>
                                                    <th className="px-4 py-3 text-left text-sm font-medium">IMDB</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-700">
                                                {results.map((result, idx) => (
                                                    <tr key={idx} className="hover:bg-gray-700/50">
                                                        <td className="px-4 py-3">
                                                            {result.title || result.original_title}
                                                        </td>
                                                        <td className="px-4 py-3 text-gray-400">
                                                            {result.year || '-'}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs border ${getStatusBadge(result.status)}`}>
                                                                {result.status}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm">
                                                            {result.streaming_services.length > 0 
                                                                ? result.streaming_services.join(', ')
                                                                : result.error || '-'}
                                                        </td>
                                                        <td className="px-4 py-3">
                                                            <a 
                                                                href={`https://www.imdb.com/title/${result.imdb_id}`}
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                className="text-blue-400 hover:text-blue-300 text-sm"
                                                            >
                                                                {result.imdb_id}
                                                            </a>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'config' && (
                            <div className="space-y-6">
                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <h2 className="text-xl font-semibold mb-4">API Configuration</h2>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-2">IMDB Watchlist URL</label>
                                            <input
                                                type="text"
                                                value={config.imdbListUrl}
                                                onChange={(e) => setConfig({...config, imdbListUrl: e.target.value})}
                                                placeholder="https://www.imdb.com/user/urXXXXXXXX/watchlist/"
                                                className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                            />
                                            <p className="text-xs text-gray-400 mt-1">Get this from your IMDB watchlist page URL</p>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-2">Plex Token</label>
                                            <input
                                                type="password"
                                                value={config.plexToken}
                                                onChange={(e) => setConfig({...config, plexToken: e.target.value})}
                                                placeholder="Your Plex authentication token"
                                                className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                            />
                                            <p className="text-xs text-gray-400 mt-1">Find this in Plex Settings → Account → Get Token</p>
                                        </div>
                                        
                                        <div>
                                            <label className="block text-sm font-medium mb-2">TMDB API Key</label>
                                            <input
                                                type="password"
                                                value={config.tmdbApiKey}
                                                onChange={(e) => setConfig({...config, tmdbApiKey: e.target.value})}
                                                placeholder="Your TMDB API key"
                                                className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                            />
                                            <p className="text-xs text-gray-400 mt-1">Get a free API key from themoviedb.org</p>
                                        </div>

                                        <div>
                                            <label className="block text-sm font-medium mb-2">Region</label>
                                            <select
                                                value={config.region}
                                                onChange={(e) => setConfig({...config, region: e.target.value})}
                                                className="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
                                            >
                                                {regions.map(region => (
                                                    <option key={region} value={region}>{region}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gray-800 p-6 rounded-lg">
                                    <h2 className="text-xl font-semibold mb-4">Streaming Services</h2>
                                    <p className="text-sm text-gray-400 mb-4">
                                        Select the streaming services you have access to. Content available on these services will be skipped.
                                    </p>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {streamingProviders.map(provider => (
                                            <button
                                                key={provider.id}
                                                onClick={() => handleServiceToggle(provider.id)}
                                                className={`p-3 rounded-lg border-2 transition-all ${
                                                    config.streamingServices.includes(provider.id)
                                                        ? 'border-blue-500 bg-blue-500/20'
                                                        : 'border-gray-600 hover:border-gray-500'
                                                }`}
                                            >
                                                <span className="font-medium">{provider.name}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <button
                                    onClick={saveConfig}
                                    className="w-full bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-medium transition-colors"
                                >
                                    Save Configuration
                                </button>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="bg-gray-800 p-6 rounded-lg">
                                <h2 className="text-xl font-semibold mb-4">Activity Logs</h2>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {logs.length === 0 ? (
                                        <div className="text-gray-400 text-center py-8">No logs yet</div>
                                    ) : (
                                        logs.map((log, idx) => (
                                            <div key={idx} className="flex gap-3 text-sm py-2 border-b border-gray-700">
                                                <span className="text-gray-500 font-mono text-xs">
                                                    {new Date(log.timestamp).toLocaleTimeString()}
                                                </span>
                                                <span className={`${
                                                    log.type === 'success' ? 'text-green-400' :
                                                    log.type === 'warning' ? 'text-yellow-400' :
                                                    log.type === 'error' ? 'text-red-400' :
                                                    'text-gray-300'
                                                }`}>
                                                    {log.message}
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ImdbPlexSync />, document.getElementById('root'));
    </script>
</body>
</html>
