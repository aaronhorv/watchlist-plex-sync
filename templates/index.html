<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMDB to Plex Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab.active {
            background: white;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .status-banner {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-banner.syncing {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .status-banner.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .status-value {
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .sync-status.active {
            display: flex;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sync-status-text {
            flex: 1;
        }
        
        .sync-status-text h3 {
            margin-bottom: 5px;
            color: #856404;
        }
        
        .sync-status-text p {
            color: #856404;
            margin: 0;
        }
        
        .logs {
            max-height: 500px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }
        
        .log-info {
            color: #4ec9b0;
        }
        
        .log-success {
            color: #6bc950;
        }
        
        .log-warning {
            color: #f9ae3f;
        }
        
        .log-error {
            color: #f44747;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.added {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.skipped {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .service-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .service-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .service-item label {
            flex: 1;
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }
        
        .region-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .region-select:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ IMDB to Plex Sync</h1>
            <p>Automatically sync your IMDB watchlist to Plex</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('sync')">üîÑ Sync & Results</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
            <button class="tab" onclick="switchTab('logs')">üìù Logs</button>
        </div>
        
        <div id="sync-tab" class="tab-content active">
            <div class="sync-status" id="syncStatus">
                <div class="spinner"></div>
                <div class="sync-status-text">
                    <h3>‚è≥ Syncing in progress...</h3>
                    <p id="syncProgress">Please wait while we sync your watchlist</p>
                </div>
            </div>
            
            <div class="card">
                <h2>üöÄ Start Sync</h2>
                <p style="margin-bottom: 20px; color: #666;">Click the button below to start syncing your IMDB watchlist to Plex. This will fetch all items from your watchlist, check streaming availability, and add them to your Plex watchlist.</p>
                <button class="btn" id="syncButton" onclick="startSync()">üîÑ Start Sync Now</button>
            </div>
            
            <div class="card">
                <h2>üìä Status</h2>
                <div class="status-banner" id="statusBanner">
                    <div class="status-item">
                        <div class="status-label">Last Sync</div>
                        <div class="status-value" id="lastSync" style="font-size: 16px;">Never</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Processed</div>
                        <div class="status-value" id="processed">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Added to Plex</div>
                        <div class="status-value" id="added" style="color: #28a745;">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Skipped</div>
                        <div class="status-value" id="skipped" style="color: #ffc107;">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Results</h2>
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No results yet. Run a sync to see results here.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="config-tab" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è IMDB & API Configuration</h2>
                <div class="form-group">
                    <label>IMDB List URL</label>
                    <input type="text" id="imdbUrl" placeholder="https://www.imdb.com/user/urXXXXXXXX/watchlist or https://www.imdb.com/list/lsXXXXXXXX/">
                </div>
                <div class="form-group">
                    <label>Plex Token</label>
                    <input type="password" id="plexToken" placeholder="Your Plex authentication token">
                </div>
                <div class="form-group">
                    <label>TMDB API Key</label>
                    <input type="password" id="tmdbKey" placeholder="Your TMDB API key">
                </div>
            </div>
            
            <div class="card">
                <h2>üì∫ Streaming Services</h2>
                <p style="margin-bottom: 20px; color: #666;">Select the streaming services you have access to. Movies available on these services will be skipped during sync.</p>
                
                <div id="streamingServices">
                    <div class="service-item">
                        <input type="checkbox" id="service-netflix" value="8">
                        <label for="service-netflix">Netflix</label>
                        <select id="region-netflix" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="IT">Italy</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="AU">Australia</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-prime" value="119">
                        <label for="service-prime">Amazon Prime Video</label>
                        <select id="region-prime" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="IT">Italy</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="AU">Australia</option>
                            <option value="JP">Japan</option>
                            <option value="IN">India</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-disney" value="337">
                        <label for="service-disney">Disney+</label>
                        <select id="region-disney" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="IT">Italy</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="AU">Australia</option>
                            <option value="JP">Japan</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-hbo" value="384">
                        <label for="service-hbo">HBO Max</label>
                        <select id="region-hbo" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="ES">Spain</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-apple" value="350">
                        <label for="service-apple">Apple TV+</label>
                        <select id="region-apple" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="FR">France</option>
                            <option value="ES">Spain</option>
                            <option value="IT">Italy</option>
                            <option value="BR">Brazil</option>
                            <option value="MX">Mexico</option>
                            <option value="AU">Australia</option>
                            <option value="JP">Japan</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-paramount" value="531">
                        <label for="service-paramount">Paramount+</label>
                        <select id="region-paramount" class="region-select">
                            <option value="US">United States</option>
                            <option value="DE" selected>Germany</option>
                            <option value="GB">United Kingdom</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-hulu" value="15">
                        <label for="service-hulu">Hulu</label>
                        <select id="region-hulu" class="region-select">
                            <option value="US" selected>United States</option>
                            <option value="JP">Japan</option>
                        </select>
                    </div>
                    
                    <div class="service-item">
                        <input type="checkbox" id="service-peacock" value="386">
                        <label for="service-peacock">Peacock</label>
                        <select id="region-peacock" class="region-select">
                            <option value="US" selected>United States</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn" onclick="saveConfig()" style="margin-top: 20px;">üíæ Save Configuration</button>
            </div>
        </div>
        
        <div id="logs-tab" class="tab-content">
            <div class="card">
                <h2>üìù Application Logs</h2>
                <div class="logs" id="logs">
                    <div class="log-entry log-info">Waiting for activity...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let syncInterval = null;
        let isSyncing = false;
        
        window.onload = function() {
            loadConfig();
            loadStatus();
            loadLogs();
            loadResults();
            
            // Refresh logs every 3 seconds
            setInterval(loadLogs, 3000);
            
            // Check sync status every 2 seconds
            setInterval(checkSyncStatus, 2000);
        };
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                document.getElementById('imdbUrl').value = config.imdbListUrl || '';
                document.getElementById('plexToken').value = config.plexToken || '';
                document.getElementById('tmdbKey').value = config.tmdbApiKey || '';
                
                // Load streaming services
                const services = config.streamingServices || [];
                services.forEach(service => {
                    const checkbox = document.querySelector(`input[value="${service.id}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        const serviceName = checkbox.id.replace('service-', '');
                        const regionSelect = document.getElementById(`region-${serviceName}`);
                        if (regionSelect && service.region) {
                            regionSelect.value = service.region;
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        async function saveConfig() {
            // Collect enabled streaming services
            const streamingServices = [];
            const services = [
                {id: '8', name: 'netflix'},
                {id: '119', name: 'prime'},
                {id: '337', name: 'disney'},
                {id: '384', name: 'hbo'},
                {id: '350', name: 'apple'},
                {id: '531', name: 'paramount'},
                {id: '15', name: 'hulu'},
                {id: '386', name: 'peacock'}
            ];
            
            services.forEach(service => {
                const checkbox = document.getElementById(`service-${service.name}`);
                if (checkbox && checkbox.checked) {
                    const regionSelect = document.getElementById(`region-${service.name}`);
                    streamingServices.push({
                        id: parseInt(service.id),
                        region: regionSelect ? regionSelect.value : 'US'
                    });
                }
            });
            
            const config = {
                imdbListUrl: document.getElementById('imdbUrl').value,
                plexToken: document.getElementById('plexToken').value,
                tmdbApiKey: document.getElementById('tmdbKey').value,
                streamingServices: streamingServices
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    alert('‚úÖ Configuration saved successfully!');
                }
            } catch (error) {
                alert('‚ùå Error saving configuration: ' + error.message);
            }
        }
        
        async function startSync() {
            if (isSyncing) {
                alert('‚è≥ Sync already in progress!');
                return;
            }
            
            const button = document.getElementById('syncButton');
            button.disabled = true;
            button.textContent = '‚è≥ Syncing...';
            
            isSyncing = true;
            document.getElementById('syncStatus').classList.add('active');
            
            try {
                const response = await fetch('/api/sync', {method: 'POST'});
                if (response.ok) {
                    console.log('Sync started successfully');
                }
            } catch (error) {
                alert('‚ùå Error starting sync: ' + error.message);
                isSyncing = false;
                button.disabled = false;
                button.textContent = 'üîÑ Start Sync Now';
                document.getElementById('syncStatus').classList.remove('active');
            }
        }
        
        async function checkSyncStatus() {
            const logs = await fetch('/api/logs').then(r => r.json()).catch(() => []);
            const recentLogs = logs.slice(-10);
            
            // Check if sync is complete
            const hasCompleteMessage = recentLogs.some(log => 
                log.message.includes('Complete:') || 
                log.message.includes('processed')
            );
            
            const hasStartMessage = recentLogs.some(log => 
                log.message.includes('Starting sync')
            );
            
            if (isSyncing && hasCompleteMessage) {
                // Keep on sync tab to show results
                loadStatus();
                loadResults();
            } else if (hasStartMessage && !isSyncing) {
                // Sync was started externally
                isSyncing = true;
                document.getElementById('syncStatus').classList.add('active');
                const button = document.getElementById('syncButton');
                button.disabled = true;
                button.textContent = '‚è≥ Syncing...';
            }
        }
        
        function switchTabProgrammatic(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if ((tabName === 'sync' && index === 0) ||
                    (tabName === 'config' && index === 1) ||
                    (tabName === 'logs' && index === 2)) {
                    tab.classList.add('active');
                }
            });
        }
        
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('lastSync').textContent = 
                    status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
                document.getElementById('processed').textContent = status.processed || 0;
                document.getElementById('added').textContent = status.added || 0;
                document.getElementById('skipped').textContent = status.skipped || 0;
                
                // Update banner style
                const banner = document.getElementById('statusBanner');
                if (status.processed > 0) {
                    banner.classList.add('success');
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                
                const logsDiv = document.getElementById('logs');
                logsDiv.innerHTML = logs.slice(-100).reverse().map(log => {
                    const className = 'log-' + log.type;
                    return `<div class="log-entry ${className}">[${log.timestamp}] ${log.message}</div>`;
                }).join('');
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const results = await response.json();
                
                const container = document.getElementById('resultsContainer');
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No results yet. Run a sync to see results here.</p>
                        </div>
                    `;
                    return;
                }
                
                const tableHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Year</th>
                                <th>IMDB ID</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(result => `
                                <tr>
                                    <td><strong>${result.title || result.original_title}</strong></td>
                                    <td>${result.year || 'N/A'}</td>
                                    <td><code>${result.imdb_id}</code></td>
                                    <td><span class="status-badge ${result.status}">${result.status.toUpperCase()}</span></td>
                                    <td>
                                        ${result.streaming_services && result.streaming_services.length > 0 
                                            ? result.streaming_services.join(', ') 
                                            : result.error || '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }
    </script>
</body>
</html>
