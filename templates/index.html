<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlist Sync</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%23667eea'/><stop offset='100%25' stop-color='%23764ba2'/></linearGradient></defs><rect width='100' height='100' rx='20' fill='url(%23g)'/><text y='.9em' font-size='80' text-anchor='middle' x='50' dominant-baseline='middle' dy='5'>üé¨</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab.active {
            background: white;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }
        
        .status-banner {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-banner.syncing {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .status-banner.success {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .status-value {
            color: #333;
            font-size: 24px;
            font-weight: 700;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .sync-status.active {
            display: flex;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .sync-status-text {
            flex: 1;
        }
        
        .sync-status-text h3 {
            margin-bottom: 5px;
            color: #856404;
        }
        
        .sync-status-text p {
            color: #856404;
            margin: 0;
        }
        
        .logs {
            max-height: 500px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
        }
        
        .log-info {
            color: #4ec9b0;
        }
        
        .log-success {
            color: #6bc950;
        }
        
        .log-warning {
            color: #f9ae3f;
        }
        
        .log-error {
            color: #f44747;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.added {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.skipped {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .service-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .service-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .service-item label {
            flex: 1;
            font-weight: 500;
            color: #333;
            cursor: pointer;
        }
        
        .region-select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .region-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .source-fields {
            display: none;
        }

        .source-fields.active {
            display: block;
        }

        .config-sub-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .config-sub-tab {
            background: #f0f0f0;
            color: #555;
            padding: 10px 20px;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s, color 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .config-sub-tab:hover {
            background: #e0e0e0;
        }

        .config-sub-tab.active {
            background: white;
            color: #667eea;
            border-color: #667eea;
        }

        .config-sub-content {
            display: none;
        }

        .config-sub-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Watchlist to Plex Sync</h1>
            <p>Automatically sync your IMDB, TMDB, or Trakt watchlist to Plex</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('sync')">üîÑ Sync & Results</button>
            <button class="tab" onclick="switchTab('config')">‚öôÔ∏è Configuration</button>
            <button class="tab" onclick="switchTab('logs')">üìù Logs</button>
        </div>
        
        <div id="sync-tab" class="tab-content active">
            <div class="sync-status" id="syncStatus">
                <div class="spinner"></div>
                <div class="sync-status-text">
                    <h3>‚è≥ Syncing in progress...</h3>
                    <p id="syncProgress">Please wait while we sync your watchlist</p>
                </div>
            </div>
            
            <div class="card">
                <h2>üöÄ Start Sync</h2>
                <p style="margin-bottom: 20px; color: #666;">Click the button below to start syncing your IMDB watchlist to Plex. This will fetch all items from your watchlist, check streaming availability, and add them to your Plex watchlist.</p>
                <button class="btn" id="syncButton" onclick="startSync()">üîÑ Start Sync Now</button>
            </div>
            
            <div class="card">
                <h2>üìä Status</h2>
                <div class="status-banner" id="statusBanner">
                    <div class="status-item">
                        <div class="status-label">Last Sync</div>
                        <div class="status-value" id="lastSync" style="font-size: 16px;">Never</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Processed</div>
                        <div class="status-value" id="processed">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Added to Plex</div>
                        <div class="status-value" id="added" style="color: #28a745;">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Skipped</div>
                        <div class="status-value" id="skipped" style="color: #ffc107;">0</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Removed</div>
                        <div class="status-value" id="removed" style="color: #dc3545;">0</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Results</h2>
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No results yet. Run a sync to see results here.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="config-tab" class="tab-content">
            <!-- Sub-tab navigation -->
            <div style="background: white; border-radius: 12px 12px 0 0; padding: 20px 30px 0 30px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); margin-bottom: 0;">
                <div class="config-sub-tabs">
                    <button class="config-sub-tab active" id="cfg-tab-input" onclick="switchConfigSubTab('input')">üìã Input List</button>
                    <button class="config-sub-tab" id="cfg-tab-plex" onclick="switchConfigSubTab('plex')">üñ•Ô∏è Plex &amp; TMDB</button>
                </div>
            </div>

            <!-- Sub-tab: Input List -->
            <div class="config-sub-content active" id="cfg-sub-input">
                <div class="card" style="border-radius: 0 0 12px 12px; margin-top: 0;">
                    <div class="form-group">
                        <label>Input Source</label>
                        <select id="sourceSelector" onchange="selectSource(this.value)" style="width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:6px; font-size:15px; cursor:pointer; background:white; color:#333; transition: border-color 0.3s;">
                            <option value="imdb">üé¨ IMDB</option>
                            <option value="tmdb">üé• TMDB List</option>
                            <option value="tmdb_watchlist">üëÅÔ∏è TMDB Watchlist</option>
                            <option value="trakt">üì° Trakt</option>
                        </select>
                    </div>

                    <!-- IMDB fields -->
                    <div class="source-fields active" id="fields-imdb">
                        <div class="form-group">
                            <label>IMDB Watchlist URL</label>
                            <input type="text" id="imdbUrl" placeholder="https://www.imdb.com/user/urXXXXXXXX/watchlist or https://www.imdb.com/list/lsXXXXXXXX/">
                            <small style="color:#888;">Your IMDB watchlist or list URL (must be public)</small>
                        </div>
                    </div>

                    <!-- TMDB List fields -->
                    <div class="source-fields" id="fields-tmdb">
                        <div class="form-group">
                            <label>TMDB List ID</label>
                            <input type="text" id="tmdbListId" placeholder="e.g. 8303833">
                            <small style="color:#888;">The numeric ID from your TMDB list URL (themoviedb.org/list/XXXXXXX)</small>
                        </div>
                    </div>

                    <!-- TMDB Watchlist fields -->
                    <div class="source-fields" id="fields-tmdb_watchlist">
                        <p style="color:#666; margin-bottom:16px; font-size:14px;">
                            Authenticate with TMDB to access your watchlist. Your TMDB API Key must be saved in the Plex &amp; TMDB tab first.
                        </p>

                        <!-- Step 1 -->
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <button type="button" class="btn" id="getTokenBtn" onclick="getTmdbRequestToken()"
                                        style="padding:10px 20px; font-size:14px;">Step 1: Get Request Token</button>
                                <span id="tokenStatus" style="font-size:14px; color:#555;"></span>
                            </div>
                        </div>

                        <!-- Step 2: Approval link (hidden until token obtained) -->
                        <div id="tmdbApprovalSection" style="display:none; margin-bottom:16px; padding:14px; background:#f0f4ff; border-radius:8px; border:1px solid #c5d0f5;">
                            <p style="margin-bottom:8px; font-size:14px; color:#333; font-weight:500;">Step 2: Approve the token at TMDB</p>
                            <a id="tmdbApproveLink" href="#" target="_blank" style="color:#667eea; font-size:14px; word-break:break-all;"></a>
                            <p style="margin-top:8px; font-size:13px; color:#888;">Click the link above, log in if needed, then come back and click Step 3.</p>
                        </div>

                        <!-- Step 3 -->
                        <div id="tmdbStep3Section" style="display:none; margin-bottom:16px; align-items:center; gap:12px; flex-wrap:wrap;">
                            <button type="button" class="btn" id="createSessionBtn" onclick="createTmdbSession()"
                                    style="padding:10px 20px; font-size:14px;">Step 3: Create Session ID</button>
                            <span id="sessionStatus" style="font-size:14px; color:#555;"></span>
                        </div>

                        <div class="form-group">
                            <label>TMDB Session ID</label>
                            <input type="password" id="tmdbSessionId" placeholder="Populated automatically via Step 3, or enter manually">
                        </div>
                        <div class="form-group" style="margin-top: 4px; display: flex; align-items: center;">
                            <button type="button" class="btn btn-secondary" id="fetchAccountIdBtn" onclick="fetchTmdbAccountId()" style="margin-left: 0; padding: 10px 20px; font-size: 14px;">Fetch Account ID</button>
                            <span id="fetchAccountIdStatus" style="margin-left: 12px; font-size: 14px; color: #555;"></span>
                        </div>
                        <div class="form-group">
                            <label>TMDB Account ID</label>
                            <input type="text" id="tmdbAccountId" placeholder="Populated automatically via Fetch, or enter manually">
                        </div>
                    </div>

                    <!-- Trakt fields -->
                    <div class="source-fields" id="fields-trakt">
                        <div class="form-group">
                            <label>Trakt List URL</label>
                            <input type="text" id="traktUrl" placeholder="https://app.trakt.tv/users/me/watchlist">
                            <small style="color:#888;">Your Trakt watchlist or custom list URL</small>
                        </div>
                        <div class="form-group">
                            <label>Trakt Client ID</label>
                            <input type="password" id="traktApiKey" placeholder="Your Trakt Client ID">
                            <small style="color:#888;">Create a free app at <a href="https://trakt.tv/oauth/applications" target="_blank" style="color:#667eea;">trakt.tv/oauth/applications</a></small>
                        </div>
                        <div class="form-group">
                            <label>Trakt Client Secret</label>
                            <input type="password" id="traktClientSecret" placeholder="Your Trakt Client Secret">
                        </div>

                        <!-- Step 1 -->
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <button type="button" class="btn" id="traktAuthBtn" onclick="startTraktAuth()"
                                        style="padding:10px 20px; font-size:14px;">Step 1: Authorize with Trakt</button>
                                <span id="traktAuthStatus" style="font-size:14px; color:#555;"></span>
                            </div>
                        </div>

                        <!-- Step 2: User code (hidden until Step 1) -->
                        <div id="traktCodeSection" style="display:none; margin-bottom:16px; padding:14px; background:#f0f4ff; border-radius:8px; border:1px solid #c5d0f5;">
                            <p style="margin-bottom:8px; font-size:14px; color:#333; font-weight:500;">Step 2: Enter this code at Trakt</p>
                            <div id="traktUserCode" style="font-size:28px; font-weight:700; letter-spacing:6px; color:#667eea; margin-bottom:8px;"></div>
                            <a id="traktVerifyLink" href="https://trakt.tv/activate" target="_blank" style="color:#667eea; font-size:14px;">trakt.tv/activate</a>
                            <p style="margin-top:8px; font-size:13px; color:#888;">Enter the code above, then wait ‚Äî this page will update automatically when authorized.</p>
                            <p style="margin-top:4px; font-size:13px; color:#555;" id="traktPollStatus"></p>
                        </div>

                        <div id="traktSuccessSection" style="display:none; margin-bottom:16px; padding:10px 14px; background:#d4edda; border-radius:8px; border:1px solid #c3e6cb; color:#155724; font-size:14px; font-weight:500;">
                            ‚úì Authorized! Access token saved. You can re-authorize at any time.
                        </div>
                    </div>

                    <button class="btn" onclick="saveConfig()" style="margin-top: 20px;">üíæ Save Configuration</button>
                </div>
            </div>

            <!-- Sub-tab: Plex & TMDB -->
            <div class="config-sub-content" id="cfg-sub-plex">
                <div class="card" style="border-radius: 0 0 12px 12px; margin-top: 0; margin-bottom: 20px;">
                    <h2>üñ•Ô∏è Plex &amp; TMDB API</h2>
                    <div class="form-group">
                        <label>Plex Token</label>
                        <input type="password" id="plexToken" placeholder="Your Plex authentication token">
                    </div>
                    <div class="form-group">
                        <label>TMDB API Key</label>
                        <input type="password" id="tmdbKey" placeholder="Your TMDB API key (v3)">
                        <small style="color:#888;">Required for streaming availability checks and TMDB sources. Get a free key at <a href="https://www.themoviedb.org/settings/api" target="_blank" style="color:#667eea;">themoviedb.org</a></small>
                    </div>
                    <button class="btn" onclick="saveConfig()" style="margin-top: 4px;">üíæ Save Configuration</button>
                </div>

                <div class="card">
                    <h2>üì∫ Streaming Services</h2>
                    <p style="margin-bottom: 20px; color: #666;">Select the streaming services you have access to. Movies available on these services will be skipped during sync.</p>

                    <div id="streamingServices">
                        <div class="service-item">
                            <input type="checkbox" id="service-netflix" value="8">
                            <label for="service-netflix">Netflix</label>
                            <select id="region-netflix" class="region-select">
                                <option value="US">US</option>
                                <option value="DE" selected>DE</option>
                                <option value="GB">GB</option>
                                <option value="CA">CA</option>
                                <option value="FR">FR</option>
                                <option value="ES">ES</option>
                                <option value="IT">IT</option>
                                <option value="BR">BR</option>
                                <option value="MX">MX</option>
                                <option value="AU">AU</option>
                                <option value="JP">JP</option>
                                <option value="IN">IN</option>
                                <option value="HU">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-prime" value="119">
                            <label for="service-prime">Amazon Prime Video</label>
                            <select id="region-prime" class="region-select">
                                <option value="US">US</option>
                                <option value="DE" selected>DE</option>
                                <option value="GB">GB</option>
                                <option value="CA">CA</option>
                                <option value="FR">FR</option>
                                <option value="ES">ES</option>
                                <option value="IT">IT</option>
                                <option value="BR">BR</option>
                                <option value="MX">MX</option>
                                <option value="AU">AU</option>
                                <option value="JP">JP</option>
                                <option value="IN">IN</option>
                                <option value="HU">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-disney" value="337">
                            <label for="service-disney">Disney+</label>
                            <select id="region-disney" class="region-select">
                                <option value="US">US</option>
                                <option value="DE" selected>DE</option>
                                <option value="GB">GB</option>
                                <option value="CA">CA</option>
                                <option value="FR">FR</option>
                                <option value="ES">ES</option>
                                <option value="IT">IT</option>
                                <option value="BR">BR</option>
                                <option value="MX">MX</option>
                                <option value="AU">AU</option>
                                <option value="JP">JP</option>
                                <option value="HU">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-hbo" value="384">
                            <label for="service-hbo">HBO Max</label>
                            <select id="region-hbo" class="region-select" onchange="updateHBOValue(this)">
                                <option value="US" data-provider="384">US</option>
                                <option value="DE" data-provider="384" selected>DE</option>
                                <option value="GB" data-provider="384">GB</option>
                                <option value="ES" data-provider="384">ES</option>
                                <option value="BR" data-provider="384">BR</option>
                                <option value="MX" data-provider="384">MX</option>
                                <option value="HU" data-provider="1899">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-apple" value="350">
                            <label for="service-apple">Apple TV+</label>
                            <select id="region-apple" class="region-select">
                                <option value="US">US</option>
                                <option value="DE" selected>DE</option>
                                <option value="GB">GB</option>
                                <option value="CA">CA</option>
                                <option value="FR">FR</option>
                                <option value="ES">ES</option>
                                <option value="IT">IT</option>
                                <option value="BR">BR</option>
                                <option value="MX">MX</option>
                                <option value="AU">AU</option>
                                <option value="JP">JP</option>
                                <option value="HU">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-paramount" value="531">
                            <label for="service-paramount">Paramount+</label>
                            <select id="region-paramount" class="region-select">
                                <option value="US">US</option>
                                <option value="DE" selected>DE</option>
                                <option value="GB">GB</option>
                                <option value="CA">CA</option>
                                <option value="AU">AU</option>
                                <option value="HU">HU</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-hulu" value="15">
                            <label for="service-hulu">Hulu</label>
                            <select id="region-hulu" class="region-select">
                                <option value="US" selected>US</option>
                                <option value="JP">JP</option>
                            </select>
                        </div>

                        <div class="service-item">
                            <input type="checkbox" id="service-peacock" value="386">
                            <label for="service-peacock">Peacock</label>
                            <select id="region-peacock" class="region-select">
                                <option value="US" selected>US</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn" onclick="saveConfig()" style="margin-top: 20px;">üíæ Save Configuration</button>
                </div>
            </div>
        </div>
        
        <div id="logs-tab" class="tab-content">
            <div class="card">
                <h2>üìù Application Logs</h2>
                <div class="logs" id="logs">
                    <div class="log-entry log-info">Waiting for activity...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let syncInterval = null;
        let isSyncing = false;
        let currentSource = 'imdb';

        function selectSource(source) {
            currentSource = source;
            // Sync dropdown (in case called programmatically from loadConfig)
            document.getElementById('sourceSelector').value = source;
            // Show/hide field sections
            document.querySelectorAll('.source-fields').forEach(el => el.classList.remove('active'));
            document.getElementById('fields-' + source).classList.add('active');
        }

        window.onload = function() {
            loadConfig();
            loadStatus();
            loadLogs();
            loadResults();
            
            // Refresh logs every 3 seconds
            setInterval(loadLogs, 3000);
            
            // Check sync status every 2 seconds
            setInterval(checkSyncStatus, 2000);
        };
        
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Restore list source
                if (config.listSource) {
                    selectSource(config.listSource);
                }

                document.getElementById('imdbUrl').value = config.imdbListUrl || '';
                document.getElementById('tmdbListId').value = config.tmdbListId || '';
                document.getElementById('tmdbAccountId').value = config.tmdbAccountId || '';
                document.getElementById('tmdbSessionId').value = config.tmdbSessionId || '';
                document.getElementById('traktUrl').value = config.traktListUrl || '';
                document.getElementById('traktApiKey').value = config.traktApiKey || '';
                document.getElementById('traktClientSecret').value = config.traktClientSecret || '';
                if (config.traktAccessToken) {
                    document.getElementById('traktSuccessSection').style.display = 'block';
                }
                document.getElementById('plexToken').value = config.plexToken || '';
                document.getElementById('tmdbKey').value = config.tmdbApiKey || '';
                
                // Load streaming services
                const services = config.streamingServices || [];
                services.forEach(service => {
                    // For HBO Max, check both standard (384) and Hungary (1899) provider IDs
                    let checkbox = document.querySelector(`input[value="${service.id}"]`);
                    if (!checkbox && service.id === 1899) {
                        // Hungary HBO Max - check the HBO checkbox
                        checkbox = document.getElementById('service-hbo');
                    }
                    
                    if (checkbox) {
                        checkbox.checked = true;
                        const serviceName = checkbox.id.replace('service-', '');
                        const regionSelect = document.getElementById(`region-${serviceName}`);
                        if (regionSelect && service.region) {
                            regionSelect.value = service.region;
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        async function saveConfig(silent = false) {
            // Collect enabled streaming services
            const streamingServices = [];
            const services = [
                {id: '8', name: 'netflix'},
                {id: '119', name: 'prime'},
                {id: '337', name: 'disney'},
                {id: '384', name: 'hbo', regionSpecific: true}, // HBO has different IDs per region
                {id: '350', name: 'apple'},
                {id: '531', name: 'paramount'},
                {id: '15', name: 'hulu'},
                {id: '386', name: 'peacock'}
            ];
            
            services.forEach(service => {
                const checkbox = document.getElementById(`service-${service.name}`);
                if (checkbox && checkbox.checked) {
                    const regionSelect = document.getElementById(`region-${service.name}`);
                    const region = regionSelect ? regionSelect.value : 'US';
                    
                    // For HBO Max, use region-specific provider ID
                    let providerId = parseInt(service.id);
                    if (service.regionSpecific && regionSelect) {
                        const selectedOption = regionSelect.options[regionSelect.selectedIndex];
                        const regionProviderId = selectedOption.getAttribute('data-provider');
                        if (regionProviderId) {
                            providerId = parseInt(regionProviderId);
                        }
                    }
                    
                    streamingServices.push({
                        id: providerId,
                        region: region
                    });
                }
            });
            
            // Fetch current saved config to preserve backend-only fields
            // (traktAccessToken, traktRefreshToken) that are never shown in the UI
            let saved = {};
            try { saved = await fetch('/api/config').then(r => r.json()); } catch (_) {}

            const config = {
                ...saved,
                listSource: currentSource,
                imdbListUrl: document.getElementById('imdbUrl').value,
                tmdbListId: document.getElementById('tmdbListId').value,
                tmdbAccountId: document.getElementById('tmdbAccountId').value,
                tmdbSessionId: document.getElementById('tmdbSessionId').value,
                traktListUrl: document.getElementById('traktUrl').value,
                traktApiKey: document.getElementById('traktApiKey').value,
                traktClientSecret: document.getElementById('traktClientSecret').value,
                plexToken: document.getElementById('plexToken').value,
                tmdbApiKey: document.getElementById('tmdbKey').value,
                streamingServices: streamingServices
            };

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    if (!silent) alert('‚úÖ Configuration saved successfully!');
                }
            } catch (error) {
                if (!silent) alert('‚ùå Error saving configuration: ' + error.message);
            }
        }
        
        async function startSync() {
            if (isSyncing) {
                alert('‚è≥ Sync already in progress!');
                return;
            }
            
            const button = document.getElementById('syncButton');
            button.disabled = true;
            button.textContent = '‚è≥ Syncing...';
            
            isSyncing = true;
            document.getElementById('syncStatus').classList.add('active');
            
            try {
                const response = await fetch('/api/sync', {method: 'POST'});
                if (response.ok) {
                    console.log('Sync started successfully');
                }
            } catch (error) {
                alert('‚ùå Error starting sync: ' + error.message);
                isSyncing = false;
                button.disabled = false;
                button.textContent = 'üîÑ Start Sync Now';
                document.getElementById('syncStatus').classList.remove('active');
            }
        }
        
        async function checkSyncStatus() {
            const logs = await fetch('/api/logs').then(r => r.json()).catch(() => []);
            const recentLogs = logs.slice(-10);
            
            // Check if sync is complete
            const hasCompleteMessage = recentLogs.some(log => 
                log.message.includes('Complete:') || 
                log.message.includes('processed')
            );
            
            const hasStartMessage = recentLogs.some(log => 
                log.message.includes('Starting sync')
            );
            
            if (isSyncing && hasCompleteMessage) {
                isSyncing = false;
                document.getElementById('syncStatus').classList.remove('active');
                const button = document.getElementById('syncButton');
                button.disabled = false;
                button.textContent = 'üîÑ Start Sync Now';
                loadStatus();
                loadResults();
            } else if (hasStartMessage && !isSyncing) {
                // Sync was started externally
                isSyncing = true;
                document.getElementById('syncStatus').classList.add('active');
                const button = document.getElementById('syncButton');
                button.disabled = true;
                button.textContent = '‚è≥ Syncing...';
            }
        }
        
        function switchTabProgrammatic(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if ((tabName === 'sync' && index === 0) ||
                    (tabName === 'config' && index === 1) ||
                    (tabName === 'logs' && index === 2)) {
                    tab.classList.add('active');
                }
            });
        }
        
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('lastSync').textContent = 
                    status.lastSync ? new Date(status.lastSync).toLocaleString() : 'Never';
                document.getElementById('processed').textContent = status.processed || 0;
                document.getElementById('added').textContent = status.added || 0;
                document.getElementById('skipped').textContent = status.skipped || 0;
                document.getElementById('removed').textContent = status.removed || 0;
                
                // Update banner style
                const banner = document.getElementById('statusBanner');
                if (status.processed > 0) {
                    banner.classList.add('success');
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                
                const logsDiv = document.getElementById('logs');
                logsDiv.innerHTML = logs.slice(-100).reverse().map(log => {
                    const className = 'log-' + log.type;
                    return `<div class="log-entry ${className}">[${log.timestamp}] ${log.message}</div>`;
                }).join('');
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }
        
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const results = await response.json();
                
                const container = document.getElementById('resultsContainer');
                
                if (results.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No results yet. Run a sync to see results here.</p>
                        </div>
                    `;
                    return;
                }
                
                const tableHTML = `
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Year</th>
                                <th>IMDB ID</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...results].reverse().map(result => `
                                <tr>
                                    <td><strong>${result.title || result.original_title}</strong></td>
                                    <td>${result.year || 'N/A'}</td>
                                    <td><code>${result.imdb_id}</code></td>
                                    <td><span class="status-badge ${result.status}">${result.status.toUpperCase()}</span></td>
                                    <td>
                                        ${result.streaming_services && result.streaming_services.length > 0 
                                            ? result.streaming_services.join(', ') 
                                            : result.error || '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }
        let _traktDeviceCode = null;
        let _traktPollTimer = null;
        let _traktPollSeconds = 5;

        async function startTraktAuth() {
            const btn = document.getElementById('traktAuthBtn');
            const statusEl = document.getElementById('traktAuthStatus');
            // Validate credentials before doing anything
            const clientId = document.getElementById('traktApiKey').value.trim();
            const clientSecret = document.getElementById('traktClientSecret').value.trim();
            if (!clientId || !clientSecret) {
                statusEl.textContent = 'Enter both Client ID and Client Secret first.';
                statusEl.style.color = '#dc3545';
                return;
            }
            // Save first so backend has the latest Client ID and Secret
            await saveConfig(true);
            if (_traktPollTimer) { clearInterval(_traktPollTimer); _traktPollTimer = null; }
            btn.disabled = true;
            statusEl.textContent = 'Requesting device code‚Ä¶';
            statusEl.style.color = '#555';
            try {
                const res = await fetch('/api/trakt/device-code', {method: 'POST'});
                const data = await res.json();
                if (res.ok && data.device_code) {
                    _traktDeviceCode = data.device_code;
                    _traktPollSeconds = data.interval || 5;
                    document.getElementById('traktUserCode').textContent = data.user_code;
                    const link = document.getElementById('traktVerifyLink');
                    link.href = data.verification_url || 'https://trakt.tv/activate';
                    link.textContent = data.verification_url || 'trakt.tv/activate';
                    document.getElementById('traktCodeSection').style.display = 'block';
                    document.getElementById('traktSuccessSection').style.display = 'none';
                    statusEl.textContent = '';
                    startTraktPolling();
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown');
                    statusEl.style.color = '#dc3545';
                    btn.disabled = false;
                }
            } catch (e) {
                statusEl.textContent = 'Network error: ' + e.message;
                statusEl.style.color = '#dc3545';
                btn.disabled = false;
            }
        }

        function startTraktPolling() {
            const pollStatus = document.getElementById('traktPollStatus');
            pollStatus.textContent = 'Waiting for authorization‚Ä¶';
            // Capture credentials now; backend also reads from config as fallback
            const clientSecret = document.getElementById('traktClientSecret').value.trim();
            _traktPollTimer = setInterval(async () => {
                try {
                    const res = await fetch('/api/trakt/device-token', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({device_code: _traktDeviceCode, client_secret: clientSecret})
                    });
                    const data = await res.json();
                    if (res.status === 200 && data.status === 'success') {
                        clearInterval(_traktPollTimer);
                        _traktPollTimer = null;
                        document.getElementById('traktCodeSection').style.display = 'none';
                        document.getElementById('traktSuccessSection').style.display = 'block';
                        document.getElementById('traktAuthBtn').disabled = false;
                        document.getElementById('traktAuthStatus').textContent = '';
                        _traktDeviceCode = null;
                    } else if (res.status === 429) {
                        _traktPollSeconds *= 2;
                        clearInterval(_traktPollTimer);
                        _traktPollTimer = null;
                        setTimeout(startTraktPolling, _traktPollSeconds * 1000);
                    } else if (res.status === 418 || res.status === 410) {
                        clearInterval(_traktPollTimer);
                        _traktPollTimer = null;
                        pollStatus.textContent = data.error || 'Authorization failed ‚Äî restart.';
                        pollStatus.style.color = '#dc3545';
                        document.getElementById('traktAuthBtn').disabled = false;
                    } else if (res.status === 422) {
                        clearInterval(_traktPollTimer);
                        _traktPollTimer = null;
                        pollStatus.textContent = 'Config error: ' + (data.error || 'Missing credentials ‚Äî re-enter Client ID and Secret, then re-authorize.');
                        pollStatus.style.color = '#dc3545';
                        document.getElementById('traktAuthBtn').disabled = false;
                    } else if (res.status !== 400) {
                        pollStatus.textContent = 'Unexpected error (' + res.status + '): ' + (data.error || 'Unknown');
                        pollStatus.style.color = '#dc3545';
                    }
                    // 400 = still pending from Trakt, keep polling
                } catch (e) {
                    console.warn('Trakt poll error:', e);
                    // keep polling ‚Äî likely a transient network hiccup
                }
            }, _traktPollSeconds * 1000);
        }

        let _tmdbRequestToken = null;

        async function getTmdbRequestToken() {
            const btn = document.getElementById('getTokenBtn');
            const statusEl = document.getElementById('tokenStatus');
            btn.disabled = true;
            statusEl.textContent = 'Requesting token‚Ä¶';
            statusEl.style.color = '#555';
            try {
                const res = await fetch('/api/tmdb/token');
                const data = await res.json();
                if (res.ok && data.request_token) {
                    _tmdbRequestToken = data.request_token;
                    statusEl.textContent = `‚úì Token obtained (expires: ${data.expires_at})`;
                    statusEl.style.color = '#28a745';
                    const approvalSection = document.getElementById('tmdbApprovalSection');
                    const approveLink = document.getElementById('tmdbApproveLink');
                    approvalSection.style.display = 'block';
                    approveLink.href = data.approve_url;
                    approveLink.textContent = data.approve_url;
                    document.getElementById('tmdbStep3Section').style.display = 'flex';
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown');
                    statusEl.style.color = '#dc3545';
                }
            } catch (e) {
                statusEl.textContent = 'Network error: ' + e.message;
                statusEl.style.color = '#dc3545';
            } finally {
                btn.disabled = false;
            }
        }

        async function createTmdbSession() {
            const statusEl = document.getElementById('sessionStatus');
            if (!_tmdbRequestToken) {
                statusEl.textContent = 'Get a request token first (Step 1).';
                statusEl.style.color = '#dc3545';
                return;
            }
            const btn = document.getElementById('createSessionBtn');
            btn.disabled = true;
            statusEl.textContent = 'Creating session‚Ä¶';
            statusEl.style.color = '#555';
            try {
                const res = await fetch('/api/tmdb/session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({request_token: _tmdbRequestToken})
                });
                const data = await res.json();
                if (res.ok && data.session_id) {
                    document.getElementById('tmdbSessionId').value = data.session_id;
                    statusEl.textContent = '‚úì Session created and saved!';
                    statusEl.style.color = '#28a745';
                    _tmdbRequestToken = null;
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown');
                    statusEl.style.color = '#dc3545';
                }
            } catch (e) {
                statusEl.textContent = 'Network error: ' + e.message;
                statusEl.style.color = '#dc3545';
            } finally {
                btn.disabled = false;
            }
        }

        function switchConfigSubTab(name) {
            document.querySelectorAll('.config-sub-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.config-sub-content').forEach(c => c.classList.remove('active'));
            document.getElementById('cfg-tab-' + name).classList.add('active');
            document.getElementById('cfg-sub-' + name).classList.add('active');
        }

        async function fetchTmdbAccountId() {
            const sessionId = document.getElementById('tmdbSessionId').value.trim();
            const statusEl = document.getElementById('fetchAccountIdStatus');
            const btn = document.getElementById('fetchAccountIdBtn');
            if (!sessionId) {
                statusEl.textContent = 'Enter a Session ID first.';
                statusEl.style.color = '#dc3545';
                return;
            }
            btn.disabled = true;
            statusEl.textContent = 'Fetching‚Ä¶';
            statusEl.style.color = '#555';
            try {
                const res = await fetch(`/api/tmdb/account?session_id=${encodeURIComponent(sessionId)}`);
                const data = await res.json();
                if (res.ok && data.account_id) {
                    document.getElementById('tmdbAccountId').value = data.account_id;
                    statusEl.textContent = `‚úì ${data.username} (ID: ${data.account_id})`;
                    statusEl.style.color = '#28a745';
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Unknown');
                    statusEl.style.color = '#dc3545';
                }
            } catch (e) {
                statusEl.textContent = 'Network error: ' + e.message;
                statusEl.style.color = '#dc3545';
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
